{
    "collab_server" : "",
    "contents" : "# MSC performance table\nlibrary(shiny)\nlibrary(DLMtool)\nlibrary(kableExtra)\nlibrary(formattable)\nlibrary(knitr)\n\nMPs<-c('FMSYref','AvC','DCAC','curE','matlenlim','MRreal')\nMSEobj<-runMSE(testOM,MPs=MPs,AnnualMSY=F)\nload(\"C:/GitHub/FRAME/inst/shiny_apps/FRAME/MSEobj\")\nload(\"C:/GitHub/FRAME/inst/shiny_apps/FRAME/MSEobj_FB\")\n\n\n#OM_FB<-testOM\n#OM_FB<-readRDS(\"C:/GitHub/FRAME/inst/shiny_apps/FRAME/OM_autosave.rda\")\n#OM_FB@D<-c(0.1,0.4)  #seq(0.05,0.4,length.out=testOM@nsim)\n#OM_FB@proyears<-8\n#OM_FB@interval<-3\n\nMPs<-MSEobj@MPs\n\n\n#MSEobj_FB<-runMSE(OM_FB,MPs=MPs,AnnualMSY=F)\n#MP<-2\n#proyear<-1\n#Blev<-MSEobj_FB@B_BMSY[,MP,proyear]\n#Dep<-MSEobj_FB@OM$Depletion\n#Sref<-MSEobj_FB@OM$SSBMSY_SSB0\n#B_BMSY_guess<-Dep/Sref\n#B_BMSY_reported<-MSEobj_FB@B_BMSY[,MP,proyear]\n#plot(B_BMSY_guess,B_BMSY_reported)\n#lines(c(-10,10),c(-10,10))\n\n\nrnd=0\nEyr=10\nPcrit<-0.1\n\nMSC_P_tab<-function(MSEobj,MSEobj_FB,Eyr=10,rnd=0,Pcrit=0.2){\n\n  # PI 1.1.1\n  PI.111.a<-round(apply(MSEobj@B_BMSY[,,1:Eyr]>0.5,2,mean)*100,rnd)\n  PI.111.b<-round(apply(MSEobj@B_BMSY[,,1:Eyr]>1,2,mean)*100,rnd)\n\n  # PI 1.1.2\n  #MGT<-((-log(1-MSEobj@OM$L50/MSEobj@OM$Linf))/MSEobj@OM$K)+MSEobj@OM$t0\n  #2*MGT\n  MGT2<-ceiling(MSEobj@OM$MGT*2)\n  MGT2[MGT2<3]=3\n  Bind<-cbind(as.matrix(expand.grid(1:MSEobj@nsim,1:MSEobj@nMPs)),rep(MGT2,MSEobj@nMPs))\n  Bmat<-array(MSEobj@B_BMSY[Bind],c(MSEobj@nsim,MSEobj@nMPs))\n  PI.112<-round(apply(Bmat>1,2,mean)*100,rnd)\n\n  # PI 1.2.1\n  PI.121.a<-round(apply(MSEobj@B_BMSY[,,11:50]>0.5,2,mean)*100,rnd)\n  PI.121.b<-round(apply(MSEobj@B_BMSY[,,11:50]>1,2,mean)*100,rnd)\n\n  # PI 1.2.2\n  PI.122.a<-rep(\"F\",MSEobj@nMPs)\n  #plot(x=MSEobj_FB@OM$Depletion/MSEobj_FB@OM$SSBMSY_SSB0,y=  MSEobj_FB@B_BMSY[,10,1])\n  par(mfrow=c(4,5),mar=c(2,2,0.01,0.01))\n  for(i in 1:MSEobj@nMPs){\n\n    cond<-MSEobj_FB@B_BMSY[,i,1]<1 & MSEobj_FB@B_BMSY[,i,1]>0.1\n    plot(MSEobj_FB@B_BMSY[!cond,i,1],MSEobj_FB@F_FMSY[!cond,i,2],col=\"#99999998\",pch=19)\n\n    dat<-data.frame(x=MSEobj_FB@B_BMSY[cond,i,1],y=MSEobj_FB@F_FMSY[cond,i,2])\n    temp<-lm(y~x,dat=dat)\n    stemp<-summary(temp)\n    Pval<-stemp$coefficients[2,4]\n    Slope<-stemp$coefficient[2,1]\n    pos<-Slope>0\n    points(MSEobj_FB@B_BMSY[cond,i,1],MSEobj_FB@F_FMSY[cond,i,2],col=\"#ff000098\",pch=19)\n    if(pos & Pval<Pcrit)PI.122.a[i]<-\"P\"\n    legend('topright',legend=c(paste(\"pval=\",round(Pval,3)),paste(\"slope=\",round(Slope,3))),bty='n')\n    legend('topleft',MSEobj@MPs[i],bty='n')\n\n  }\n\n  PI.122.b<-round(apply(MSEobj@F_FMSY[,,1:50]>0.5 &  MSEobj@F_FMSY[,,1:50]<1.5,2,mean)*100,rnd)\n\n  # LTY\n  refY<-sum(MSEobj@C[,1,11:50])\n  LTY<-round(apply(MSEobj@C[,,11:50],2,sum)/refY*100,rnd)\n  MP<-MSEobj@MPs\n  rnd<-0\n\n\n  tab<-data.frame(MP,PI.111.a, PI.111.b, PI.112, PI.121.a, PI.121.b,\n                  PI.122.a, PI.122.b, LTY)\n  tab\n\n}\n\n\nPtab1<-Ptab(MSEobj,MSEobj_FB)\n\n#                                       11a 11b 12  21a 21b 22  LTY\nPtab_formatted<-function(Ptab1,thresh=c(80, 50, 50, 80, 60, 80, 50)){\n  Ptab2<-Ptab1[,2:ncol(Ptab1)]\n  row.names(Ptab2)<-Ptab1[,1]\n  names(Ptab2)<-c(\"PI111a\",\"PI111b\",\"PI112\",\"PI121a\",\"PI121b\",\"PI122a\",\"PI122b\",\"LTY\")\n\n  Ptab2 %>%\n    mutate(\n      MP = row.names(.),\n      PI111a = ifelse(PI111a >= thresh[1],\n                 cell_spec(PI111a, \"html\", color = \"green\", bold = T),\n                 cell_spec(PI111a, \"html\", color = \"red\", italic = T)),\n      PI111b = ifelse(PI111b >= thresh[2],\n                 cell_spec(PI111b, \"html\", color = \"green\", bold = T),\n                 cell_spec(PI111b, \"html\", color = \"red\", italic = T)),\n      PI112 = ifelse(PI112 >= thresh[3],\n                 cell_spec(PI112, \"html\", color = \"green\", bold = T),\n                 cell_spec(PI112, \"html\", color = \"red\", italic = T)),\n      PI121a = ifelse(PI121a >= thresh[4],\n                 cell_spec(PI121a, \"html\", color = \"green\", bold = T),\n                 cell_spec(PI121a, \"html\", color = \"red\", italic = T)),\n      PI121b = ifelse(PI121b >= thresh[5],\n                 cell_spec(PI121b, \"html\", color = \"green\", bold = T),\n                 cell_spec(PI121b, \"html\", color = \"red\", italic = T)),\n      #PI122a <-ifelse(PI122a==\"P\",\n      #           cell_spec(PI122a, \"html\", color = \"red\", bold = T),\n      #           cell_spec(PI122a, \"html\", color = \"green\", italic = T)),\n      PI122b = ifelse(PI122b >= thresh[6],\n                 cell_spec(PI122b, \"html\", color = \"green\", bold = T),\n                 cell_spec(PI122b, \"html\", color = \"red\", italic = T)),\n      LTY = ifelse(LTY >= thresh[7],\n                 cell_spec(LTY, \"html\", color = \"green\", bold = T),\n                 cell_spec(LTY, \"html\", color = \"red\", italic = T))\n\n    )  %>%\n    select(MP, everything()) %>%\n    kable(\"html\", escape = F,align = \"c\") %>%\n    kable_styling(\"striped\", full_width = F)%>%\n    column_spec(5, width = \"3cm\") %>%\n    add_header_above(c(\" \", \"> 0.5 BMSY\" = 1, \"> BMSY\" = 1,\n                       \"> BMSY\"=1,\"> 0.5 BMSY\"=1,\"> BMSY\"=1,\"P/F\"=1,\n                       \"0.5 - 1.5 FMSY\"=1,\"vs FMSYref\"=1))%>%\n    add_header_above(c(\" \", \"Biomass (yrs 1-10)\" = 2, \"Biomass (2 MGT)\" = 1,\n                       \"Biomass (yrs 11-50)\"=2,\"F decrease w B\"=1,\n                       \"Fishing Mortality (yrs 1-50)\"=1,\n                       \"yrs 11-50\"=1))%>%\n    add_header_above(c(\" \", \"Stock Status\" = 2, \"Rebuilding\" = 1,\n                       \"Harvest Strategy\"=2,\"HCR & Tools\"=2,\n                       \"Long-Term Yield\"=1))\n\n}\n\n\n\nmtcars[1:10, 1:2] %>%\n  mutate(\n    car = row.names(.),\n    # You don't need format = \"html\" if you have ever defined options(knitr.table.format)\n    mpg = cell_spec(mpg, \"html\", color = ifelse(mpg > 20, \"red\", \"blue\")),\n    cyl = cell_spec(cyl, \"html\", color = \"white\", align = \"c\", angle = 45,\n                    background = factor(cyl, c(4, 6, 8),\n                                        c(\"#666666\", \"#999999\", \"#BBBBBB\")))\n  ) %>%\n  select(car, mpg, cyl) %>%\n  kable(\"html\", escape = F) %>%\n  kable_styling(\"striped\", full_width = F)\n\n\n\n\nHCRplot<-function(MSEobj){\n\n  nMPs<-MSEobj@nMPs\n  ncol=ceiling(nMPs*0.25)\n  nrow=ceiling(nMPs/ncol)\n  par(mfrow=c(nrow,ncol),mai=c(0.4,0.4,0.01,0.01),omi=c(0.3,0.3,0.01,0.01))\n\n  for(i in 1:MSEobj@nMPs){\n\n    cond<-MSEobj_FB@B_BMSY[,i,1]<1 & MSEobj_FB@B_BMSY[,i,1]>0.1\n    plot(MSEobj_FB@B_BMSY[,i,1],MSEobj_FB@F_FMSY[,i,2],col=\"white\",pch=19,xlim=c(0,1.6),xlab=\"\",ylab=\"\")\n    points(MSEobj_FB@B_BMSY[!cond,i,1],MSEobj_FB@F_FMSY[!cond,i,2],col=\"#99999998\",pch=19)\n\n    dat<-data.frame(x=MSEobj_FB@B_BMSY[cond,i,1],y=MSEobj_FB@F_FMSY[cond,i,2])\n    temp<-lm(y~x,dat=dat)\n    stemp<-summary(temp)\n    pred<-predict(temp,newdata=data.frame(x=seq(0.1,1,length.out=20)))\n    Pval<-stemp$coefficients[2,4]\n    Slope<-stemp$coefficient[2,1]\n    pos<-Slope>0\n\n    col<-'red'\n    if(pos & Pval<Pcrit)col=\"green\"\n    points(MSEobj_FB@B_BMSY[cond,i,1],MSEobj_FB@F_FMSY[cond,i,2],col=col,pch=19)\n    lines(seq(0.1,1,length.out=20),pred,col=col)\n    legend('topright',legend=c(paste(\"pval=\",round(Pval,3)),paste(\"slope=\",round(Slope,3))),bty='n')\n    legend('topleft',MSEobj@MPs[i],bty='n',text.font=2,text.col=col)\n\n  }\n  mtext(\"F/FMSY\",2,line=0.3,outer=T)\n  mtext(\"B/BMSY\",1,line=0.3,outer=T)\n\n}\n",
    "created" : 1523378100204.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "4214738288",
    "id" : "C8EE08AF",
    "lastKnownWriteTime" : 1523379029,
    "last_content_update" : 1523379029395,
    "path" : "C:/Users/Tom/Dropbox/MSC_DLMtool_App/Development Code/PI table.R",
    "project_path" : null,
    "properties" : {
    },
    "relative_order" : 3,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}